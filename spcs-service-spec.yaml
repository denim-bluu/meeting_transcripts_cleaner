# Snowpark Container Services (SPCS) Multi-Container Service Specification
# This file defines the deployment configuration for the Meeting Transcript Cleaner
# as a decoupled FastAPI backend + Streamlit frontend architecture.

spec:
  containers:
  
  # Backend Service - FastAPI with all AI processing logic
  - name: backend
    image: /<database_name>/<schema_name>/<repository_name>/transcript-backend:latest
    env:
      # OpenAI API configuration
      OPENAI_API_KEY: "##SECRET:openai_api_key##"
      
      # Snowflake connection (uses SPCS session token automatically)
      SNOWFLAKE_WAREHOUSE: <your_warehouse_name>
      SNOWFLAKE_DATABASE: <your_database_name>
      SNOWFLAKE_SCHEMA: <your_schema_name>
      
      # Application configuration
      CLEANING_MODEL: "o3-mini"
      REVIEW_MODEL: "o3-mini" 
      
      # Performance tuning
      MAX_CONCURRENT_TASKS: "10"
      TASK_TIMEOUT_SECONDS: "600"
      MEMORY_CLEANUP_INTERVAL: "3600"
    
    # Resource allocation for AI processing
    resources:
      requests:
        cpu: "1000m"      # 1 CPU core
        memory: "2Gi"     # 2GB RAM for AI models
      limits:
        cpu: "2000m"      # 2 CPU cores max
        memory: "4Gi"     # 4GB RAM max
    
    # Health checks
    readinessProbe:
      httpGet:
        path: /health
        port: 8000
      initialDelaySeconds: 30
      periodSeconds: 10
    
    livenessProbe:
      httpGet:
        path: /health
        port: 8000
      initialDelaySeconds: 60
      periodSeconds: 30
  
  # Frontend Service - Streamlit UI
  - name: frontend
    image: /<database_name>/<schema_name>/<repository_name>/transcript-frontend:latest
    env:
      # Backend API connection (internal SPCS network)
      BACKEND_URL: "http://backend:8000"
      
      # Streamlit configuration
      STREAMLIT_SERVER_HEADLESS: "true"
      STREAMLIT_BROWSER_GATHER_USAGE_STATS: "false"
      STREAMLIT_SERVER_PORT: "8501"
    
    # Lightweight resource allocation for UI
    resources:
      requests:
        cpu: "250m"       # 0.25 CPU core
        memory: "512Mi"   # 512MB RAM
      limits:
        cpu: "500m"       # 0.5 CPU core max
        memory: "1Gi"     # 1GB RAM max
    
    # Health checks
    readinessProbe:
      httpGet:
        path: /_stcore/health
        port: 8501
      initialDelaySeconds: 15
      periodSeconds: 10
    
    livenessProbe:
      httpGet:
        path: /_stcore/health
        port: 8501
      initialDelaySeconds: 30
      periodSeconds: 30

  # Network endpoints - only frontend is exposed publicly
  endpoints:
  - name: streamlit-ui
    port: 8501
    public: true        # Public access to Streamlit UI
    # The backend (port 8000) is NOT exposed publicly for security
    # Frontend communicates with backend via internal SPCS network

  # Service configuration
  min_instances: 1
  max_instances: 3      # Auto-scale based on load